<!DOCTYPE html>
<html>
<head>
    <title>Bat Chat</title>
    <link rel="stylesheet" type="text/css" href="css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <script src="js/sockjs-0.3.4.js"></script>
    <script src="js/stomp.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="js/jquery-1.11.3.min.js"></script>
    <script type="text/javascript">
        var stompClient = null;

        function sleep(ms) {
            ms += new Date().getTime();
            while (new Date() < ms){}
        }

        function setConnected(connected) {
            document.getElementById('response').innerHTML = '';
        }

        function connect() {
            var socket = new SockJS('/hello');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function(frame) {
                stompClient.subscribe('/topic/greetings', function(greeting){
                    showGreeting(JSON.parse(greeting.body));
                });
                stompClient.subscribe('/topic/history', function(greeting){
                    showHistory(JSON.parse(greeting.body));
                });
            });
            sendHistoryQuery();
        }

        function disconnect() {
            if (stompClient != null) {
                stompClient.disconnect();
            }
            setConnected(false);
        }

        function sendName() {
            var content = document.getElementById('content').value;
            stompClient.send("/app/hello", {}, JSON.stringify({ 'content': content }));
            document.getElementById('content').value = '';
        }

        function sendHistoryQuery(){
            if(stompClient.ws.readyState === SockJS.CONNECTING && stompClient.ws.subscheck != 2)
                setTimeout(sendHistoryQuery, 100);
            else
                stompClient.send("/app/history", {}, JSON.stringify({ 'content': '' }));
        }

        function showGreeting(message) {
            document.getElementById('response').innerHTML = document.getElementById('response').innerHTML +
                '<code><font color="#0000aa">' + message.author + '</font></code>: ' + message.content + '<br>';
            lastMessage = message;
        }

        function showHistory(history){
            for(i=0; i < history.authors.length; i++){
                showGreeting({"author": history.authors[i], "content": history.contents[i]});
            }
        }

        function messageInputKeyCheck( keyboardInfo ){
            if( keyboardInfo.keyCode == 13 ) sendName();
        }
    </script>
</head>
<body onload="connect()" id="thebody">
    <div class="navbar navbar-static navbar-inverse navbar-fixed-top" id="navbar">
        <div class="navbar-inner">
            <div class="container" style="width: auto;">
                <a class="brand" style="color: #fff;"> &nbsp;Bat Chat</a>
                <ul class="nav" role="navigation">
                    <li class="dropdown" align="left">
                        <a class="dropdown-toggle" role="button" data-toggle="dropdown" style="color: #fff;">
                            <i class="icon-th-list icon-white"></i>
                            Rooms
                            <b class="caret"></b>
                        </a>
                        <ul class="dropdown-menu" role="menu">
                            <li>
                                <a href="#" tabindex="-1">
                                    <i class="icon-th-list"></i>
                                    Room List
                                </a>
                            </li>
                            <li>
                                <a href="#" tabindex="-1">
                                    <i class="icon-user"></i>
                                    My Rooms
                                </a>
                            </li>
                            <li class="divider"></li>
                            <li>
                                <a href="#" tabindex="-1">
                                    <i class="icon-plus"></i>
                                    Create Room
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
                #!ADMINTOOLSLIST!#
                <ul class="nav pull-right" role="navigation">
                    <li class="dropdown" align="left">
                        <a class="dropdown-toggle" id="username" role="button" data-toggle="dropdown"  style="color: #fff;">
                            <i class="icon-user icon-white"></i>
                            #!USERNAME!#
                            <b class="caret"></b>
                        </a>
                        <ul class="dropdown-menu" role="menu">
                            <li>
                                <a href="#" tabindex="-1">
                                    <i class="icon-user"></i>
                                    User Info
                                </a>
                            </li>
                            <li class="divider"></li>
                            <li>
                                <a href="#" tabindex="-1">
                                    <i class="icon-remove"></i>
                                    Log Out
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="span12" id="allcontent">
            <h3 id="roomname">
                Room #!ROOMNAME!#
            </h3>
            <div class="container">
                <div class="well span8" style="height: 400px; overflow-y: scroll; text-align: left; word-wrap: break-word;" id="response">
                </div>
                <div class="well span2" style="height:400px; overflow-y: scroll; overflow-x: scroll; font-size: 9pt; text-align: left;" id="roomuserlist">
                    #!USERLIST!#
                </div>
                <div class="container" id="messageform">
                    <input type="text" class="span8 search-query" id="content" placeholder="Your message" onkeyup="messageInputKeyCheck(event)">
                    <button class="btn btn-primary" id="messagesubmit" onclick="sendName()">Send</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>